@page "/admin/upload"
@inject HttpClient Http

<PageTitle>GW2 Raid Stats - Upload Logs</PageTitle>

<AdminAuth>
<MudText Typo="Typo.h4" Class="mb-4">Upload Logs</MudText>

<MudGrid>
    @* File Upload Section *@
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Class="mr-2" />
                Upload Files
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4">
                Upload Elite Insights JSON log files directly from your browser.
            </MudText>

            <MudFileUpload T="IReadOnlyList<IBrowserFile>"
                           Accept=".json"
                           MaximumFileCount="500"
                           FilesChanged="OnFilesSelected"
                           Class="mb-4">
                <ActivatorContent>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.AttachFile"
                               Disabled="@_isUploading">
                        Select Files
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            @if (_selectedFiles.Count > 0)
            {
                <MudText Typo="Typo.body2" Class="mb-2">
                    @_selectedFiles.Count file(s) selected
                </MudText>

                <MudSlider @bind-Value="_uploadParallelism"
                           Min="1"
                           Max="8"
                           Step="1"
                           Color="Color.Primary"
                           Class="mb-3"
                           Disabled="@_isUploading">
                    Parallel uploads: @_uploadParallelism
                </MudSlider>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.Upload"
                           OnClick="UploadFilesParallel"
                           Disabled="@_isUploading"
                           Class="mb-4">
                    @if (_isUploading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Uploading...</span>
                    }
                    else
                    {
                        <span>Upload</span>
                    }
                </MudButton>
            }
        </MudPaper>
    </MudItem>

    @* Directory Import Section *@
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Folder" Class="mr-2" />
                Bulk Import from Directory (Server)
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4">
                Import all JSON files from a directory on the server. Ideal for large batch imports.
            </MudText>

            <MudTextField @bind-Value="_sourceDirectory"
                          Label="Source Directory"
                          Placeholder="/path/to/logs"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.FolderOpen"
                          Class="mb-3"
                          Disabled="@_isImporting" />

            <MudTextField @bind-Value="_completedDirectory"
                          Label="Completed Directory (optional)"
                          Placeholder="/path/to/completed"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.CheckCircle"
                          HelperText="Successfully imported files will be moved here"
                          Class="mb-3"
                          Disabled="@_isImporting" />

            <MudTextField @bind-Value="_failedDirectory"
                          Label="Failed Directory (optional)"
                          Placeholder="/path/to/failed"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Error"
                          HelperText="Failed files will be moved here"
                          Class="mb-3"
                          Disabled="@_isImporting" />

            <MudSlider @bind-Value="_parallelism"
                       Min="1"
                       Max="16"
                       Step="1"
                       Color="Color.Primary"
                       Class="mb-3"
                       Disabled="@_isImporting">
                Parallelism: @_parallelism threads
            </MudSlider>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.PlayArrow"
                       OnClick="StartDirectoryImport"
                       Disabled="@(_isImporting || string.IsNullOrWhiteSpace(_sourceDirectory))">
                @if (_isImporting)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Importing...</span>
                }
                else
                {
                    <span>Start Import</span>
                }
            </MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

@* Upload Progress Section *@
@if (_isUploading && _fileProgress.Count > 0)
{
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Class="mr-2" />
            Upload Progress
        </MudText>

        <MudGrid Class="mb-4">
            <MudItem xs="3">
                <MudText Typo="Typo.body2" Align="Align.Center">
                    <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Small" Class="mr-1" />
                    Pending: @_fileProgress.Count(f => f.Value.Status == UploadStatus.Pending)
                </MudText>
            </MudItem>
            <MudItem xs="3">
                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Info">
                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Size="Size.Small" Class="mr-1" />
                    Uploading: @_fileProgress.Count(f => f.Value.Status == UploadStatus.Uploading)
                </MudText>
            </MudItem>
            <MudItem xs="3">
                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Success">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                    Done: @_fileProgress.Count(f => f.Value.Status == UploadStatus.Completed)
                </MudText>
            </MudItem>
            <MudItem xs="3">
                <MudText Typo="Typo.body2" Align="Align.Center" Color="Color.Error">
                    <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Class="mr-1" />
                    Failed: @_fileProgress.Count(f => f.Value.Status == UploadStatus.Failed)
                </MudText>
            </MudItem>
        </MudGrid>

        @{
            var completed = _fileProgress.Count(f => f.Value.Status == UploadStatus.Completed || f.Value.Status == UploadStatus.Failed);
            var total = _fileProgress.Count;
            var percent = total > 0 ? (double)completed / total * 100 : 0;
        }
        <MudProgressLinear Color="Color.Primary" Value="@percent" Class="mb-2" />
        <MudText Typo="Typo.body2" Class="mb-4">@completed / @total files processed</MudText>

        <MudExpansionPanels>
            <MudExpansionPanel Text="File Details" Expanded="false">
                <div style="max-height: 300px; overflow-y: auto;">
                    <MudSimpleTable Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th style="width: 120px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kvp in _fileProgress.OrderBy(f => f.Value.Status == UploadStatus.Completed ? 2 : f.Value.Status == UploadStatus.Failed ? 3 : f.Value.Status == UploadStatus.Uploading ? 0 : 1))
                            {
                                <tr>
                                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        @kvp.Key
                                    </td>
                                    <td>
                                        @switch (kvp.Value.Status)
                                        {
                                            case UploadStatus.Pending:
                                                <MudChip T="string" Size="Size.Small" Color="Color.Default">Pending</MudChip>
                                                break;
                                            case UploadStatus.Uploading:
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="width: 14px; height: 14px;" Class="mr-1" />
                                                    Uploading
                                                </MudChip>
                                                break;
                                            case UploadStatus.Completed:
                                                @if (kvp.Value.WasDuplicate)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">Duplicate</MudChip>
                                                }
                                                else
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Success">Imported</MudChip>
                                                }
                                                break;
                                            case UploadStatus.Failed:
                                                <MudTooltip Text="@kvp.Value.Error">
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Failed</MudChip>
                                                </MudTooltip>
                                                break;
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudPaper>
}

@* Directory Import Progress Section *@
@if (_isImporting)
{
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Sync" Class="mr-2 mud-icon-spin" />
            Import Progress
        </MudText>
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
        <MudText Typo="Typo.body2">Processing files... Please wait.</MudText>
    </MudPaper>
}

@* Results Section *@
@if (_bulkResult != null)
{
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2" />
            Import Results
        </MudText>

        <MudGrid Class="mb-4">
            <MudItem xs="6" sm="3">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-background-grey);">
                    <MudCardContent Class="text-center">
                        <MudText Typo="Typo.h4">@_bulkResult.TotalFiles</MudText>
                        <MudText Typo="Typo.caption">Total Files</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-success-lighten);">
                    <MudCardContent Class="text-center">
                        <MudText Typo="Typo.h4" Color="Color.Success">@_bulkResult.Imported</MudText>
                        <MudText Typo="Typo.caption">Imported</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-warning-lighten);">
                    <MudCardContent Class="text-center">
                        <MudText Typo="Typo.h4" Color="Color.Warning">@_bulkResult.Duplicates</MudText>
                        <MudText Typo="Typo.caption">Duplicates</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="6" sm="3">
                <MudCard Elevation="0" Style="background-color: var(--mud-palette-error-lighten);">
                    <MudCardContent Class="text-center">
                        <MudText Typo="Typo.h4" Color="Color.Error">@_bulkResult.Failed</MudText>
                        <MudText Typo="Typo.caption">Failed</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <MudText Typo="Typo.body2" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Timer" Size="Size.Small" Class="mr-1" />
            Completed in @_bulkResult.Duration.TotalSeconds.ToString("F1") seconds
        </MudText>

        @if (_bulkResult.Results.Any(r => !r.Success))
        {
            <MudExpansionPanels Class="mt-3">
                <MudExpansionPanel Text="@($"Failed Files ({_bulkResult.Results.Count(r => !r.Success)})")">
                    <MudList T="string" Dense="true">
                        @foreach (var result in _bulkResult.Results.Where(r => !r.Success))
                        {
                            <MudListItem Icon="@Icons.Material.Filled.Error" IconColor="Color.Error">
                                <MudText Typo="Typo.body2">@result.FileName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Error">@result.Error</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    </MudPaper>
}

@if (_uploadResults.Count > 0)
{
    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.CloudDone" Class="mr-2" />
            Upload Results
        </MudText>

        <MudSimpleTable Dense="true" Striped="true">
            <thead>
                <tr>
                    <th>File</th>
                    <th>Boss</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var result in _uploadResults)
                {
                    <tr>
                        <td>@result.FileName</td>
                        <td>@(result.BossName ?? "-")</td>
                        <td>
                            @if (result.Success)
                            {
                                if (result.WasDuplicate)
                                {
                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">Duplicate</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Imported</MudChip>
                                }
                            }
                            else
                            {
                                <MudTooltip Text="@result.Error">
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">Failed</MudChip>
                                </MudTooltip>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>
    </MudPaper>
}
</AdminAuth>

@code {
    private List<IBrowserFile> _selectedFiles = new();
    private bool _isUploading;
    private bool _isImporting;
    private List<ImportResult> _uploadResults = new();
    private BulkImportResult? _bulkResult;
    private Dictionary<string, FileUploadProgress> _fileProgress = new();
    private int _uploadParallelism = 4;

    // Directory import fields
    private string _sourceDirectory = string.Empty;
    private string? _completedDirectory;
    private string? _failedDirectory;
    private int _parallelism = 8;

    private void OnFilesSelected(IReadOnlyList<IBrowserFile> files)
    {
        _selectedFiles = files.ToList();
        _fileProgress.Clear();
        _uploadResults.Clear();
    }

    private async Task UploadFilesParallel()
    {
        if (_selectedFiles.Count == 0) return;

        _isUploading = true;
        _uploadResults.Clear();
        _fileProgress = _selectedFiles.ToDictionary(
            f => f.Name,
            f => new FileUploadProgress { Status = UploadStatus.Pending }
        );
        StateHasChanged();

        try
        {
            using var semaphore = new SemaphoreSlim(_uploadParallelism);
            var tasks = _selectedFiles.Select(file => UploadSingleFileAsync(file, semaphore)).ToList();
            await Task.WhenAll(tasks);
        }
        finally
        {
            _isUploading = false;
            _selectedFiles.Clear();
            StateHasChanged();
        }
    }

    private async Task UploadSingleFileAsync(IBrowserFile file, SemaphoreSlim semaphore)
    {
        await semaphore.WaitAsync();

        try
        {
            // Update status to uploading
            _fileProgress[file.Name] = new FileUploadProgress { Status = UploadStatus.Uploading };
            await InvokeAsync(StateHasChanged);

            using var content = new MultipartFormDataContent();
            var stream = file.OpenReadStream(maxAllowedSize: 50_000_000);
            var streamContent = new StreamContent(stream);
            content.Add(streamContent, "files", file.Name);

            var response = await Http.PostAsync("api/admin/import/upload", content);

            if (response.IsSuccessStatusCode)
            {
                var results = await response.Content.ReadFromJsonAsync<List<ImportResult>>() ?? new();
                var result = results.FirstOrDefault();

                if (result != null)
                {
                    _fileProgress[file.Name] = new FileUploadProgress
                    {
                        Status = result.Success ? UploadStatus.Completed : UploadStatus.Failed,
                        Error = result.Error,
                        WasDuplicate = result.WasDuplicate,
                        BossName = result.BossName
                    };
                    _uploadResults.Add(result);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _fileProgress[file.Name] = new FileUploadProgress
                {
                    Status = UploadStatus.Failed,
                    Error = $"Server error: {error}"
                };
                _uploadResults.Add(new ImportResult(false, null, file.Name, null, $"Server error: {error}", false));
            }
        }
        catch (Exception ex)
        {
            _fileProgress[file.Name] = new FileUploadProgress
            {
                Status = UploadStatus.Failed,
                Error = ex.Message
            };
            _uploadResults.Add(new ImportResult(false, null, file.Name, null, $"Error: {ex.Message}", false));
        }
        finally
        {
            semaphore.Release();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartDirectoryImport()
    {
        if (string.IsNullOrWhiteSpace(_sourceDirectory)) return;

        _isImporting = true;
        _bulkResult = null;
        StateHasChanged();

        try
        {
            var request = new DirectoryImportRequest
            {
                SourceDirectory = _sourceDirectory,
                CompletedDirectory = string.IsNullOrWhiteSpace(_completedDirectory) ? null : _completedDirectory,
                FailedDirectory = string.IsNullOrWhiteSpace(_failedDirectory) ? null : _failedDirectory,
                MaxParallelism = _parallelism
            };

            var response = await Http.PostAsJsonAsync("api/admin/import/directory", request);

            if (response.IsSuccessStatusCode)
            {
                _bulkResult = await response.Content.ReadFromJsonAsync<BulkImportResult>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _bulkResult = new BulkImportResult(0, 0, 0, 1, TimeSpan.Zero, new List<ImportResult>
                {
                    new ImportResult(false, null, "Directory Import", null, $"Server error: {error}", false)
                });
            }
        }
        catch (Exception ex)
        {
            _bulkResult = new BulkImportResult(0, 0, 0, 1, TimeSpan.Zero, new List<ImportResult>
            {
                new ImportResult(false, null, "Directory Import", null, $"Error: {ex.Message}", false)
            });
        }
        finally
        {
            _isImporting = false;
            StateHasChanged();
        }
    }

    // DTOs matching the server models
    public record ImportResult(
        bool Success,
        Guid? EncounterId,
        string FileName,
        string? BossName,
        string? Error,
        bool WasDuplicate
    );

    public record BulkImportResult(
        int TotalFiles,
        int Imported,
        int Duplicates,
        int Failed,
        TimeSpan Duration,
        List<ImportResult> Results
    );

    public record DirectoryImportRequest
    {
        public required string SourceDirectory { get; init; }
        public string? CompletedDirectory { get; init; }
        public string? FailedDirectory { get; init; }
        public int MaxParallelism { get; init; } = 8;
    }

    public enum UploadStatus
    {
        Pending,
        Uploading,
        Completed,
        Failed
    }

    public class FileUploadProgress
    {
        public UploadStatus Status { get; set; }
        public string? Error { get; set; }
        public bool WasDuplicate { get; set; }
        public string? BossName { get; set; }
    }
}

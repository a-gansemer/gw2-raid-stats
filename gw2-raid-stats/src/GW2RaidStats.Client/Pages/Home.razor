@page "/"
@inject HttpClient Http

<PageTitle>GW2 Raid Stats - Home</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

<MudGrid>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Kills</MudText>
                <MudText Typo="Typo.h4">@(_stats?.TotalKills.ToString("N0") ?? "--")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Default">of @(_stats?.TotalEncounters.ToString("N0") ?? "--") encounters</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Success Rate</MudText>
                <MudText Typo="Typo.h4">@(_stats?.SuccessRate.ToString("F1") ?? "--")%</MudText>
                <MudText Typo="Typo.caption" Color="Color.Default">All encounters</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Active Raiders</MudText>
                <MudText Typo="Typo.h4">@(_stats?.ActiveRaidersThisMonth.ToString("N0") ?? "--")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Default">This month</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudCard Elevation="2">
            <MudCardContent>
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Raid Hours</MudText>
                <MudText Typo="Typo.h4">@(_stats?.RaidHoursThisYear.ToString("F1") ?? "--")</MudText>
                <MudText Typo="Typo.caption" Color="Color.Default">This year</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                <MudText Typo="Typo.h6">
                    Previous Session
                    @if (_previousSession != null)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-2">
                            @_previousSession.SessionTime.LocalDateTime.ToString("dddd, MMMM d, yyyy")
                        </MudText>
                    }
                </MudText>
                @if (_previousSession != null)
                {
                    <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                            @_previousSession.TotalAttempts attempts
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                            @_previousSession.TotalKills kills
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined" Title="Boss Time">
                            @FormatSessionTime(_previousSession.TotalTimeSeconds)
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined" Title="Downtime">
                            @FormatSessionTime(_previousSession.DowntimeSeconds) down
                        </MudChip>
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Download"
                                   Href="/api/reports/download-session"
                                   Target="_blank">
                            Download All
                        </MudButton>
                    </MudStack>
                }
            </MudStack>
            @if (_previousSession == null || _previousSession.Encounters.Count == 0)
            {
                <MudAlert Severity="Severity.Info" Class="mb-3">
                    No logs imported yet. Go to Admin > Upload Logs to get started.
                </MudAlert>
            }
            else
            {
                <MudSimpleTable Dense="true" Striped="true" Hover="true">
                    <thead>
                        <tr>
                            <th>Boss</th>
                            <th>Result</th>
                            <th>Duration</th>
                            <th>Time</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var encounter in _previousSession.Encounters)
                        {
                            <tr>
                                <td>
                                    @encounter.BossName
                                    @if (encounter.IsCM)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-1">CM</MudChip>
                                    }
                                </td>
                                <td>
                                    @if (encounter.Success)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Kill</MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Wipe</MudChip>
                                    }
                                </td>
                                <td>@FormatDuration(encounter.DurationMs)</td>
                                <td>@encounter.EncounterTime.LocalDateTime.ToString("h:mm tt")</td>
                                <td>
                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                                   Size="Size.Small"
                                                   Href="@($"/api/reports/{encounter.Id}/view")"
                                                   Target="_blank"
                                                   Title="View Report" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Session Highlights</MudText>
            @if (_sessionHighlights == null || (_sessionHighlights.Records.Count == 0 && _sessionHighlights.Milestones.Count == 0))
            {
                <MudText Typo="Typo.body2" Color="Color.Default">
                    No new records or milestones from this session.
                </MudText>
            }
            else
            {
                <MudStack Spacing="2">
                    @foreach (var milestone in _sessionHighlights.Milestones)
                    {
                        <MudAlert Severity="Severity.Success" Dense="true" Icon="@Icons.Material.Filled.Celebration">
                            @milestone.Description
                        </MudAlert>
                    }
                    @foreach (var record in _sessionHighlights.Records)
                    {
                        <MudPaper Class="pa-2" Elevation="0" Style="background: var(--mud-palette-background-grey);">
                            <MudStack Spacing="0">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Small" Color="Color.Warning" />
                                    <MudText Typo="Typo.body2">
                                        <strong>New @record.RecordType Record!</strong>
                                    </MudText>
                                </MudStack>
                                <MudText Typo="Typo.body2">
                                    @record.BossName@(record.IsCM ? " (CM)" : "")
                                </MudText>
                                @if (record.RecordType == "Kill Time")
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Success">
                                        @FormatDurationSeconds(record.NewValue)
                                        @if (record.PreviousValue.HasValue)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1">
                                                (was @FormatDurationSeconds(record.PreviousValue.Value))
                                            </MudText>
                                        }
                                    </MudText>
                                }
                                else
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudText Typo="Typo.body2" Color="Color.Error">
                                            @(((int)record.NewValue).ToString("N0")) DPS
                                        </MudText>
                                        @if (!string.IsNullOrEmpty(record.PlayerName))
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                by @record.PlayerName (@record.Profession)
                                            </MudText>
                                        }
                                    </MudStack>
                                    @if (record.PreviousValue.HasValue)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            Previous: @(((int)record.PreviousValue.Value).ToString("N0"))
                                        </MudText>
                                    }
                                }
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Quick Links</MudText>
            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="2">
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/players" StartIcon="@Icons.Material.Filled.Person">
                    Players
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/bosses" StartIcon="@Icons.Material.Filled.SmartToy">
                    Bosses
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/leaderboards" StartIcon="@Icons.Material.Filled.Leaderboard">
                    Leaderboards
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="/recap" StartIcon="@Icons.Material.Filled.EmojiEvents">
                    Yearly Recap
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool _loading = true;
    private DashboardStats? _stats;
    private PreviousSession? _previousSession;
    private SessionHighlights? _sessionHighlights;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        try
        {
            var statsTask = Http.GetFromJsonAsync<DashboardStats>("api/stats/dashboard");
            var sessionTask = Http.GetFromJsonAsync<PreviousSession>("api/stats/previous-session");
            var highlightsTask = Http.GetFromJsonAsync<SessionHighlights>("api/stats/session-highlights");

            await Task.WhenAll(statsTask, sessionTask, highlightsTask);

            _stats = await statsTask;
            _previousSession = await sessionTask;
            _sessionHighlights = await highlightsTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    private static string FormatDuration(int durationMs)
    {
        var ts = TimeSpan.FromMilliseconds(durationMs);
        return ts.TotalMinutes >= 1
            ? $"{(int)ts.TotalMinutes}:{ts.Seconds:D2}"
            : $"{ts.Seconds}s";
    }

    private static string FormatDurationSeconds(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        return ts.TotalMinutes >= 1
            ? $"{(int)ts.TotalMinutes}:{ts.Seconds:D2}"
            : $"{ts.Seconds}s";
    }

    private static string FormatSessionTime(double totalSeconds)
    {
        var ts = TimeSpan.FromSeconds(totalSeconds);
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{ts.Minutes}m";
    }

    // DTOs matching the server models
    public record DashboardStats(
        int TotalEncounters,
        int TotalKills,
        double SuccessRate,
        int ActiveRaidersThisMonth,
        double RaidHoursThisYear,
        int TotalPlayers
    );

    public record PreviousSession(
        DateTimeOffset SessionTime,
        List<SessionEncounter> Encounters,
        int TotalAttempts,
        int TotalKills,
        double TotalTimeSeconds,
        double DowntimeSeconds
    );

    public record SessionEncounter(
        Guid Id,
        string BossName,
        bool Success,
        bool IsCM,
        DateTimeOffset EncounterTime,
        int DurationMs,
        string? LogUrl
    );

    public record SessionHighlights(
        List<RecordBroken> Records,
        List<Milestone> Milestones
    );

    public record RecordBroken(
        string RecordType,
        string BossName,
        bool IsCM,
        string? PlayerName,
        double NewValue,
        double? PreviousValue,
        string? Profession
    );

    public record Milestone(
        string Type,
        int Value,
        string Description
    );
}

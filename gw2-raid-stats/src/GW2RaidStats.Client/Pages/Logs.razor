@page "/logs"
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>GW2 Raid Stats - Logs</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Encounter Logs</MudText>

<MudPaper Class="pa-4 mb-4" Elevation="2">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" />
        Filters
    </MudText>

    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudAutocomplete T="string"
                             Label="Boss Name"
                             @bind-Value="_bossNameFilter"
                             SearchFunc="SearchBossNames"
                             Clearable="true"
                             Variant="Variant.Outlined"
                             Dense="true"
                             ResetValueOnEmptyText="true" />
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="int?" Label="Wing" @bind-Value="_wingFilter" Clearable="true" Variant="Variant.Outlined" Dense="true">
                @foreach (var wing in _availableWings)
                {
                    <MudSelectItem Value="@((int?)wing)">Wing @wing</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="6" sm="3" md="2">
            <MudSelect T="bool?" Label="Mode" @bind-Value="_isCMFilter" Clearable="true" Variant="Variant.Outlined" Dense="true">
                <MudSelectItem Value="@((bool?)false)">Normal</MudSelectItem>
                <MudSelectItem Value="@((bool?)true)">CM</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="6" sm="3" md="2">
            <MudSelect T="bool?" Label="Result" @bind-Value="_successFilter" Clearable="true" Variant="Variant.Outlined" Dense="true">
                <MudSelectItem Value="@((bool?)true)">Kill</MudSelectItem>
                <MudSelectItem Value="@((bool?)false)">Wipe</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudTextField @bind-Value="_recordedByFilter"
                          Label="Recorded By"
                          Variant="Variant.Outlined"
                          Dense="true"
                          Clearable="true" />
        </MudItem>
        <MudItem xs="6" sm="3" md="2">
            <MudDatePicker Label="From Date"
                           @bind-Date="_fromDate"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Clearable="true" />
        </MudItem>
        <MudItem xs="6" sm="3" md="2">
            <MudDatePicker Label="To Date"
                           @bind-Date="_toDate"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Clearable="true" />
        </MudItem>
        <MudItem xs="12" sm="6" md="4">
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Search"
                           OnClick="SearchLogs">
                    Search
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="ClearFilters">
                    Clear
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Class="pa-4" Elevation="2">
    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
    }

    @if (_searchResult == null || _searchResult.Logs.Count == 0)
    {
        @if (!_loading)
        {
            <MudAlert Severity="Severity.Info">No logs found. Try adjusting your filters.</MudAlert>
        }
    }
    else
    {
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                Found @_searchResult.TotalCount.ToString("N0") logs
            </MudText>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Page size:</MudText>
                <MudSelect T="int" Value="_pageSize" ValueChanged="OnPageSizeChanged" Dense="true" Style="width: 80px;" Variant="Variant.Outlined">
                    <MudSelectItem Value="10">10</MudSelectItem>
                    <MudSelectItem Value="25">25</MudSelectItem>
                    <MudSelectItem Value="50">50</MudSelectItem>
                    <MudSelectItem Value="100">100</MudSelectItem>
                </MudSelect>
            </MudStack>
        </MudStack>

        <MudTable Items="@_searchResult.Logs"
                  Dense="true"
                  Hover="true"
                  Striped="true"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh Style="width: 50px;"></MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="bossname" T="LogEntryDto">Boss</MudTableSortLabel>
                </MudTh>
                <MudTh>Result</MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="duration" T="LogEntryDto">Duration</MudTableSortLabel>
                </MudTh>
                <MudTh>Date</MudTh>
                <MudTh>Recorded By</MudTh>
                <MudTh>Log</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="">
                    @if (!string.IsNullOrEmpty(context.IconUrl))
                    {
                        <MudAvatar Size="Size.Small">
                            <MudImage Src="@context.IconUrl" Alt="@context.BossName" />
                        </MudAvatar>
                    }
                </MudTd>
                <MudTd DataLabel="Boss">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudLink Href="@($"/bosses/{context.TriggerId}?isCM={context.IsCM}")">
                            @context.BossName
                        </MudLink>
                        @if (context.IsCM)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">CM</MudChip>
                        }
                        @if (context.IsLegendaryCM)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined">LCM</MudChip>
                        }
                        @if (context.Wing.HasValue)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">W@(context.Wing)</MudChip>
                        }
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Result">
                    @if (context.Success)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Kill</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Wipe</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Duration">@FormatDuration(context.DurationSeconds)</MudTd>
                <MudTd DataLabel="Date">@context.EncounterTime.LocalDateTime.ToString("MMM d, yyyy HH:mm")</MudTd>
                <MudTd DataLabel="Recorded By">@(context.RecordedBy ?? "-")</MudTd>
                <MudTd DataLabel="Log">
                    <MudStack Row="true" Spacing="0">
                        <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                       Size="Size.Small"
                                       Href="@($"/api/reports/{context.Id}/view")"
                                       Target="_blank"
                                       Title="View HTML Report" />
                        <MudIconButton Icon="@Icons.Material.Filled.Download"
                                       Size="Size.Small"
                                       Href="@($"/api/reports/{context.Id}/download")"
                                       Target="_blank"
                                       Title="Download .zevtc" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
        </MudTable>

        @if (_searchResult.TotalPages > 1)
        {
            <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
                <MudPagination Count="@_searchResult.TotalPages"
                               Selected="@(_currentPage + 1)"
                               SelectedChanged="OnPageChanged"
                               Color="Color.Primary"
                               ShowFirstButton="true"
                               ShowLastButton="true" />
            </MudStack>
        }
    }
</MudPaper>

@code {
    private bool _loading = true;
    private LogSearchResultDto? _searchResult;
    private List<string> _availableBossNames = new();
    private List<int> _availableWings = new();

    // Filter values
    private string? _bossNameFilter;
    private int? _wingFilter;
    private bool? _isCMFilter;
    private bool? _successFilter;
    private string? _recordedByFilter;
    private DateTime? _fromDate;
    private DateTime? _toDate;

    // Pagination
    private int _currentPage = 0;
    private int _pageSize = 25;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterOptionsAsync();
        await SearchLogs();
    }

    private async Task LoadFilterOptionsAsync()
    {
        try
        {
            var bossNamesTask = Http.GetFromJsonAsync<List<string>>("api/logs/boss-names");
            var wingsTask = Http.GetFromJsonAsync<List<int>>("api/logs/wings");

            await Task.WhenAll(bossNamesTask, wingsTask);

            _availableBossNames = bossNamesTask.Result ?? new();
            _availableWings = wingsTask.Result ?? new();
        }
        catch
        {
            _availableBossNames = new();
            _availableWings = new();
        }
    }

    private Task<IEnumerable<string>> SearchBossNames(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<string>>(_availableBossNames);

        return Task.FromResult<IEnumerable<string>>(_availableBossNames
            .Where(n => n.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private async Task SearchLogs()
    {
        _loading = true;
        _currentPage = 0;
        await LoadLogsAsync();
    }

    private async Task LoadLogsAsync()
    {
        _loading = true;
        try
        {
            var queryParams = new List<string>
            {
                $"page={_currentPage}",
                $"pageSize={_pageSize}"
            };

            if (!string.IsNullOrWhiteSpace(_bossNameFilter))
                queryParams.Add($"bossName={Uri.EscapeDataString(_bossNameFilter)}");
            if (_wingFilter.HasValue)
                queryParams.Add($"wing={_wingFilter.Value}");
            if (_isCMFilter.HasValue)
                queryParams.Add($"isCM={_isCMFilter.Value}");
            if (_successFilter.HasValue)
                queryParams.Add($"success={_successFilter.Value}");
            if (!string.IsNullOrWhiteSpace(_recordedByFilter))
                queryParams.Add($"recordedBy={Uri.EscapeDataString(_recordedByFilter)}");
            if (_fromDate.HasValue)
                queryParams.Add($"fromDate={_fromDate.Value:yyyy-MM-dd}");
            if (_toDate.HasValue)
                queryParams.Add($"toDate={_toDate.Value:yyyy-MM-dd}");

            var url = $"api/logs?{string.Join("&", queryParams)}";
            _searchResult = await Http.GetFromJsonAsync<LogSearchResultDto>(url);
        }
        catch
        {
            _searchResult = null;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ClearFilters()
    {
        _bossNameFilter = null;
        _wingFilter = null;
        _isCMFilter = null;
        _successFilter = null;
        _recordedByFilter = null;
        _fromDate = null;
        _toDate = null;
        _currentPage = 0;
        await LoadLogsAsync();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page - 1; // MudPagination is 1-based
        await LoadLogsAsync();
    }

    private async Task OnPageSizeChanged(int newSize)
    {
        _pageSize = newSize;
        _currentPage = 0;
        await LoadLogsAsync();
    }

    private string FormatDuration(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        return ts.TotalMinutes >= 1
            ? $"{(int)ts.TotalMinutes}:{ts.Seconds:D2}"
            : $"{ts.Seconds}s";
    }

    // DTOs
    public record LogSearchResultDto(
        List<LogEntryDto> Logs,
        int TotalCount,
        int Page,
        int PageSize,
        int TotalPages
    );

    public record LogEntryDto(
        Guid Id,
        int TriggerId,
        string BossName,
        int? Wing,
        bool IsCM,
        bool IsLegendaryCM,
        bool Success,
        double DurationSeconds,
        DateTimeOffset EncounterTime,
        string? RecordedBy,
        string? LogUrl,
        string? IconUrl
    );
}

@page "/leaderboards"
@inject HttpClient Http

<PageTitle>GW2 Raid Stats - Leaderboards</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Leaderboards</MudText>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}

<MudPaper Class="pa-4" Elevation="2">
    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">
        <MudTabPanel Text="Raids" Icon="@Icons.Material.Filled.Shield">
            @RenderBossTable(FilteredRaids, groupByWing: true)
        </MudTabPanel>
        <MudTabPanel Text="Strikes" Icon="@Icons.Material.Filled.Bolt">
            @RenderBossTable(FilteredStrikes, groupByWing: false)
        </MudTabPanel>
    </MudTabs>
</MudPaper>

@code {
    private static readonly Dictionary<int, string> WingNames = new()
    {
        { 1, "Wing 1 - Spirit Vale" },
        { 2, "Wing 2 - Salvation Pass" },
        { 3, "Wing 3 - Stronghold of the Faithful" },
        { 4, "Wing 4 - Bastion of the Penitent" },
        { 5, "Wing 5 - Hall of Chains" },
        { 6, "Wing 6 - Mythwright Gambit" },
        { 7, "Wing 7 - The Key of Ahdashim" },
        { 8, "Wing 8 - Mount Balrior" }
    };

    private RenderFragment RenderBossTable(IEnumerable<BossRecord> bosses, bool groupByWing = false) => __builder =>
    {
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h6">Boss Records</MudText>
            <MudStack Row="true" Spacing="2">
                <MudTextField @bind-Value="_searchString"
                              Placeholder="Search boss..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Class="mt-0" />
                <MudToggleGroup T="string" @bind-Value="_modeFilter" Color="Color.Primary" CheckMark="true">
                    <MudToggleItem Value="@("all")" Text="All" />
                    <MudToggleItem Value="@("nm")" Text="NM" />
                    <MudToggleItem Value="@("cm")" Text="CM" />
                </MudToggleGroup>
            </MudStack>
        </MudStack>

        @if (!bosses.Any())
        {
            <MudAlert Severity="Severity.Info">No boss kills found. Import some logs first!</MudAlert>
        }
        else if (groupByWing)
        {
            @* Group raids by wing *@
            var wingGroups = bosses
                .Where(b => b.Wing.HasValue)
                .GroupBy(b => b.Wing!.Value)
                .OrderBy(g => g.Key);

            @foreach (var wingGroup in wingGroups)
            {
                <MudText Typo="Typo.h5" Class="mt-4 mb-2" Color="Color.Primary">
                    <MudIcon Icon="@Icons.Material.Filled.Castle" Class="mr-2" Size="Size.Small" />
                    @(WingNames.TryGetValue(wingGroup.Key, out var name) ? name : $"Wing {wingGroup.Key}")
                </MudText>
                <MudGrid Spacing="3" Class="mb-4">
                    @foreach (var boss in wingGroup.OrderBy(b => b.EncounterOrder).ThenBy(b => b.IsCM))
                    {
                        @RenderBossCard(boss)
                    }
                </MudGrid>
            }

            @* Show bosses without wing assignment *@
            var noWingBosses = bosses.Where(b => !b.Wing.HasValue).ToList();
            @if (noWingBosses.Any())
            {
                <MudText Typo="Typo.h5" Class="mt-4 mb-2" Color="Color.Secondary">
                    Other Raids
                </MudText>
                <MudGrid Spacing="3">
                    @foreach (var boss in noWingBosses)
                    {
                        @RenderBossCard(boss)
                    }
                </MudGrid>
            }
        }
        else
        {
            @* Simple grid for strikes *@
            <MudGrid Spacing="3">
                @foreach (var boss in bosses)
                {
                    @RenderBossCard(boss)
                }
            </MudGrid>
        }
    };

    private RenderFragment RenderBossCard(BossRecord boss) => __builder =>
    {
        <MudItem xs="12" sm="6" lg="4">
            <MudCard Elevation="2" Style="height: 100%;">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6">@boss.BossName</MudText>
                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                @if (boss.IsCM)
                                {
                                    <MudChip T="string" Color="Color.Warning" Size="Size.Small">CM</MudChip>
                                }
                                <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined">
                                    @boss.KillCount kills
                                </MudChip>
                            </MudStack>
                        </MudStack>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="pt-0">
                    <MudStack Spacing="3">
                        @* Top DPS Record *@
                        @if (boss.TopDps != null)
                        {
                            <MudPaper Elevation="0" Class="pa-3" Style="background: rgba(244, 67, 54, 0.08); border-left: 4px solid var(--mud-palette-error);">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.overline" Color="Color.Error" Style="font-weight: 600;">DPS RECORD</MudText>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.End">
                                        <MudStack Spacing="0">
                                            <MudLink Href="@($"/players/{Uri.EscapeDataString(boss.TopDps.AccountName)}")" Typo="Typo.h5" Color="Color.Inherit" Style="font-weight: 700;">
                                                @boss.TopDps.AccountName
                                            </MudLink>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @boss.TopDps.CharacterName - @boss.TopDps.Profession@(boss.TopDps.WasProvidingBoons ? " (boon)" : "")
                                            </MudText>
                                        </MudStack>
                                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                                            <MudText Typo="Typo.h4" Color="Color.Error" Style="font-weight: 700; line-height: 1;">
                                                @boss.TopDps.Dps.ToString("N0")
                                            </MudText>
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @boss.TopDps.EncounterTime.LocalDateTime.ToString("MMM d, yyyy")
                                                </MudText>
                                                <MudTooltip Text="View Log">
                                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                                                   Size="Size.Small"
                                                                   Href="@($"/api/reports/{boss.TopDps.EncounterId}/view")"
                                                                   Target="_blank" />
                                                </MudTooltip>
                                            </MudStack>
                                        </MudStack>
                                    </MudStack>
                                    @if (boss.TopDps.BoonSupports.Count > 0)
                                    {
                                        <MudStack Row="true" Spacing="1" Class="mt-1">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">Support:</MudText>
                                            @foreach (var support in boss.TopDps.BoonSupports.Take(2))
                                            {
                                                <MudTooltip Text="@($"{support.CharacterName} ({support.Profession})")">
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text"
                                                             Color="@(support.BoonType == "Quickness" ? Color.Info : Color.Success)">
                                                        @support.BoonType[0]: @support.CharacterName
                                                    </MudChip>
                                                </MudTooltip>
                                            }
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudPaper>
                        }
                        else
                        {
                            <MudPaper Elevation="0" Class="pa-3" Style="background: rgba(0,0,0,0.04);">
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">No DPS record</MudText>
                            </MudPaper>
                        }

                        @* Top Boon DPS Record *@
                        @if (boss.TopBoonDps != null)
                        {
                            <MudPaper Elevation="0" Class="pa-3" Style="background: rgba(33, 150, 243, 0.08); border-left: 4px solid var(--mud-palette-info);">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudText Typo="Typo.overline" Color="Color.Info" Style="font-weight: 600;">BOON DPS RECORD</MudText>
                                        <MudChip T="string" Size="Size.Small" Variant="Variant.Filled"
                                                 Color="@(boss.TopBoonDps.BoonType == "Quickness" ? Color.Info : Color.Success)">
                                            @boss.TopBoonDps.BoonType
                                        </MudChip>
                                    </MudStack>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.End">
                                        <MudStack Spacing="0">
                                            <MudLink Href="@($"/players/{Uri.EscapeDataString(boss.TopBoonDps.AccountName)}")" Typo="Typo.subtitle1" Color="Color.Inherit" Style="font-weight: 600;">
                                                @boss.TopBoonDps.AccountName
                                            </MudLink>
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @boss.TopBoonDps.CharacterName - @boss.TopBoonDps.Profession
                                            </MudText>
                                        </MudStack>
                                        <MudStack Spacing="0" AlignItems="AlignItems.End">
                                            <MudText Typo="Typo.h5" Color="Color.Info" Style="font-weight: 600; line-height: 1;">
                                                @boss.TopBoonDps.Dps.ToString("N0")
                                            </MudText>
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @boss.TopBoonDps.EncounterTime.LocalDateTime.ToString("MMM d, yyyy")
                                                </MudText>
                                                <MudTooltip Text="View Log">
                                                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                                                   Size="Size.Small"
                                                                   Href="@($"/api/reports/{boss.TopBoonDps.EncounterId}/view")"
                                                                   Target="_blank" />
                                                </MudTooltip>
                                            </MudStack>
                                        </MudStack>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    };
}

@code {
    private bool _loading = true;
    private string _searchString = "";
    private string _modeFilter = "all";
    private List<BossRecord>? _bosses;

    private IEnumerable<BossRecord> ApplyFilters(IEnumerable<BossRecord> bosses) => bosses
        .Where(b => string.IsNullOrEmpty(_searchString) ||
                    b.BossName.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
        .Where(b => _modeFilter == "all" ||
                    (_modeFilter == "cm" && b.IsCM) ||
                    (_modeFilter == "nm" && !b.IsCM));

    private IEnumerable<BossRecord> FilteredRaids => _bosses != null
        ? ApplyFilters(_bosses.Where(b => b.IsRaid))
        : Enumerable.Empty<BossRecord>();

    private IEnumerable<BossRecord> FilteredStrikes => _bosses != null
        ? ApplyFilters(_bosses.Where(b => !b.IsRaid))
        : Enumerable.Empty<BossRecord>();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        try
        {
            _bosses = await Http.GetFromJsonAsync<List<BossRecord>>("api/leaderboard/all");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboards: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    // DTOs
    public record BossRecord(
        int TriggerId,
        string BossName,
        bool IsCM,
        int KillCount,
        LeaderboardEntry? TopDps,
        LeaderboardEntry? TopBoonDps,
        bool IsRaid,
        int? Wing = null,
        int EncounterOrder = 999
    );

    public record LeaderboardEntry(
        Guid Id,
        Guid EncounterId,
        string AccountName,
        string CharacterName,
        string Profession,
        int Dps,
        DateTimeOffset EncounterTime,
        string BossName,
        string? LogUrl,
        List<BoonSupport> BoonSupports,
        string? BoonType = null,
        bool WasProvidingBoons = false
    );

    public record BoonSupport(
        string AccountName,
        string CharacterName,
        string Profession,
        decimal QuicknessGeneration,
        decimal AlacracityGeneration
    )
    {
        public string BoonType => QuicknessGeneration >= 10 ? "Quickness" : "Alacrity";
    }
}
